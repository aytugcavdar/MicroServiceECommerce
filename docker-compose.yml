services:

  # --- VERİTABANI (POSTGRESQL) ---
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microecommerce-network
    restart: unless-stopped

  # --- VERİTABANI OLUŞTURUCU ---
  postgres-init:
    image: postgres:16-alpine
    container_name: postgres-init
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    command: >
      sh -c " echo 'Postgres başlatılıyor, bekleniyor...'; export PGPASSWORD='${POSTGRES_PASSWORD}'; until pg_isready -h postgres -U ${POSTGRES_USER} -d postgres; do echo waiting for postgres; sleep 2; done; echo 'Veritabanları oluşturuluyor...'; psql -h postgres -U ${POSTGRES_USER} -d postgres -c 'CREATE DATABASE \"MicroECommerce_IdentityDb\"' || true; psql -h postgres -U ${POSTGRES_USER} -d postgres -c 'CREATE DATABASE \"MicroECommerce_CatalogDb\"' || true; psql -h postgres -U ${POSTGRES_USER} -d postgres -c 'CREATE DATABASE \"MicroECommerce_OrderDb\"' || true; psql -h postgres -U ${POSTGRES_USER} -d postgres -c 'CREATE DATABASE \"MicroECommerce_InventoryDb\"' || true; psql -h postgres -U ${POSTGRES_USER} -d postgres -c 'CREATE DATABASE \"MicroECommerce_NotificationDb\"' || true; psql -h postgres -U ${POSTGRES_USER} -d postgres -c 'CREATE DATABASE \"MicroECommerce_PaymentDb\"' || true; echo 'Tüm veritabanları hazır!'; "
    networks:
      - microecommerce-network

  # --- REDIS (SEPET) ---
  basketdb:
    image: redis:alpine
    container_name: basketdb
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - basketdb_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microecommerce-network

  # --- RABBITMQ ---
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "${RABBITMQ_UI_PORT}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microecommerce-network
    restart: unless-stopped

  # --- LOGGING (SEQ) ---
  seq:
    image: datalust/seq:latest
    container_name: seq
    environment:
      ACCEPT_EULA: Y
      SEQ_FIRSTRUN_ADMINPASSWORD: ${SEQ_PASSWORD}
    ports:
      - "${SEQ_PORT}:80"
    volumes:
      - seq-data:/data
    networks:
      - microecommerce-network
    restart: unless-stopped

  # --- DISTRIBUTED TRACING (JAEGER) ---
  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
    networks:
      - microecommerce-network
    restart: unless-stopped

  # --- API SERVİSLERİ ---

  catalog-api:
    image: ${DOCKER_REGISTRY-}catalog-api
    container_name: catalog-api
    build:
      context: .
      dockerfile: src/Services/Catalog/Catalog.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__CatalogConnectionString=${CONNECTION_STRING_CATALOG}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__UserName=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${CATALOG_API_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  identity-api:
    image: ${DOCKER_REGISTRY-}identity-api
    container_name: identity-api
    build:
      context: .
      dockerfile: src/Services/Identity/Identity.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__IdentityConnectionString=${CONNECTION_STRING_IDENTITY}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__UserName=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - TokenOptions__SecurityKey=${JWT_SECRET}
      - TokenOptions__Issuer=${JWT_ISSUER}
      - TokenOptions__Audience=${JWT_AUDIENCE}
      - TokenOptions__AccessTokenExpiration=${JWT_ACCESS_EXP_MINUTES}
      - TokenOptions__RefreshTokenExpiration=${JWT_REFRESH_EXP_MINUTES}
      - EmailOptions__SmtpServer=${SMTP_HOST}
      - EmailOptions__SmtpPort=${SMTP_PORT}
      - EmailOptions__Username=${SMTP_USER}
      - EmailOptions__Password=${SMTP_PASS}
      - EmailOptions__SenderEmail=${SENDER_EMAIL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${IDENTITY_API_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  inventory-api:
    image: ${DOCKER_REGISTRY-}inventory-api
    container_name: inventory-api
    build:
      context: .
      dockerfile: src/Services/Inventory/Inventory.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__InventoryConnectionString=${CONNECTION_STRING_INVENTORY}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__UserName=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${INVENTORY_API_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  notification-api:
    image: ${DOCKER_REGISTRY-}notification-api
    container_name: notification-api
    build:
      context: .
      dockerfile: src/Services/Notification/Notification.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__NotificationConnectionString=${CONNECTION_STRING_NOTIFICATION}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__UserName=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - EmailOptions__SmtpServer=${SMTP_HOST}
      - EmailOptions__SmtpPort=${SMTP_PORT}
      - EmailOptions__Username=${SMTP_USER}
      - EmailOptions__Password=${SMTP_PASS}
      - EmailOptions__SenderEmail=${SENDER_EMAIL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${NOTIFICATION_API_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  payment-api:
    image: ${DOCKER_REGISTRY-}payment-api
    container_name: payment-api
    build:
      context: .
      dockerfile: src/Services/Payment/Payment.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__PaymentConnectionString=${CONNECTION_STRING_PAYMENT}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__UserName=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${PAYMENT_API_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  order-api:
    image: ${DOCKER_REGISTRY-}order-api
    container_name: order-api
    build:
      context: .
      dockerfile: src/Services/Order/Order.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__OrderConnectionString=${CONNECTION_STRING_ORDER}
      - RabbitMQ__Host=${RABBITMQ_HOST}
      - RabbitMQ__UserName=${RABBITMQ_USER}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${ORDER_API_PORT}:80"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  basket-api:
    image: ${DOCKER_REGISTRY-}basket-api
    container_name: basket-api
    build:
      context: .
      dockerfile: src/Services/Basket/Basket.API/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - CacheSettings__ConnectionString=${CONNECTION_STRING_BASKET}
      - RabbitMQSettings__Host=${RABBITMQ_HOST}
      - RabbitMQSettings__UserName=${RABBITMQ_USER}
      - RabbitMQSettings__Password=${RABBITMQ_PASSWORD}
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${BASKET_API_PORT}:80"
    depends_on:
      basketdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

  api-gateway:
    image: ${DOCKER_REGISTRY-}api-gateway
    container_name: api-gateway
    build:
      context: .
      dockerfile: src/ApiGateway/ApiGateway/Dockerfile
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:80
      - Serilog__WriteTo__1__Args__serverUrl=${SEQ_URL}
      - TokenOptions__SecurityKey=${JWT_SECRET}
      - TokenOptions__Issuer=${JWT_ISSUER}
      - TokenOptions__Audience=${JWT_AUDIENCE}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    ports:
      - "${API_GATEWAY_PORT}:80"
    depends_on:
      catalog-api:
        condition: service_started
      identity-api:
        condition: service_started
      order-api:
        condition: service_started
      basket-api:
        condition: service_started
      inventory-api:
        condition: service_started
      seq:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - microecommerce-network

networks:
  microecommerce-network:
    driver: bridge

volumes:
  postgres-data:
  seq-data:
  basketdb_data:
  rabbitmq_data:
